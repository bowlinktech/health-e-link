
/** 01.07.2014 Grace **/
UPDATE `universaltranslator`.`lookuptables` SET `utTableName`='lu_ProcedureStatus' WHERE `id`='22';
INSERT INTO `universaltranslator`.`lookuptables` (`utTableName`, `displayText`, `urlId`) VALUES ('lu_Urgency', 'Urgency', '34567Urg45677');

UPDATE `universalTranslator`.`lookUpTables` SET `utTableName`='lu_ProcessStatus' WHERE `id`='21';

/** 01.10.2014 **/
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`=NULL WHERE `id`='1';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`=NULL WHERE `id`='2';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='SSL', `displayText`='Source Submission Loaded', `description`=NULL WHERE `id`='3';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='SBP', `displayText`='Submission Being Processed', `description`=NULL WHERE `id`='4';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='SRP', `displayText`='Submission Release Pending', `description`=NULL WHERE `id`='5';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='SR', `displayText`='Submission Released', `description`=NULL WHERE `id`='6';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='SRJ', `displayText`='Submission Rejected', `description`=NULL WHERE `id`='7';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayText`='Submission Saved', `description`=NULL WHERE `id`='8';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='L', `displayText`='Loaded' WHERE `id`='9';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='RP', `displayText`='Release Pending' WHERE `id`='10';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='I', `displayText`='Invalid' WHERE `id`='11';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='REL', `displayText`='Released' WHERE `id`='12';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='RJ', `displayText`='Rejected' WHERE `id`='13';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='E', `displayText`='Error' WHERE `id`='14';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='S', `displayText`='Saved' WHERE `id`='15';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='P', `displayText`='Passed', `description`=NULL WHERE `id`='16';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `category`='transaction', `displayCode`='PP', `displayText`='Pending Pickup', `description`=NULL WHERE `id`='18';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='C', `displayText`='Closed' WHERE `id`='17';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`=NULL WHERE `id`='19';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `category`='transaction', `displayCode`='REC', `displayText`='Received', `description`=NULL WHERE `id`='20';
INSERT INTO `universaltranslator`.`lu_ProcessStatus` (`category`, `displayCode`, `displayText`) VALUES ('batch', 'DNP', 'Do Not Process');
INSERT INTO `universaltranslator`.`lu_ProcessStatus` (`category`, `displayCode`, `displayText`) VALUES ('batch', 'SDL', 'Submission Delivery Locked');
INSERT INTO `universaltranslator`.`lu_ProcessStatus` (`category`, `displayCode`, `displayText`) VALUES ('batch', 'SDC', 'Submission Delivery Completed');
INSERT INTO `universaltranslator`.`lu_ProcessStatus` (`category`, `displayCode`, `displayText`) VALUES ('batch', 'SPC', 'Submission Processing Completed');


/** Grace 01.11.2014 **/

CREATE TABLE `transactionInErrors` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `batchUploadId` int(11) NOT NULL,
  `transactionId` int(11) NOT NULL,
  `fieldLabel` varchar(45) DEFAULT NULL,
  `errorColumn` varchar(5) DEFAULT NULL COMMENT 'F1, F2, F3, etc.',
  `errorValue` varchar(255) NOT NULL,
  `rpttField1Label` varchar(45) DEFAULT NULL,
  `rptField1Val` varchar(255) DEFAULT NULL,
  `rptField2Label` varchar(45) DEFAULT NULL,
  `rptField2Val` varchar(255) DEFAULT NULL,
  `rptField3Val` varchar(45) DEFAULT NULL,
  `rptField3Label` varchar(255) DEFAULT NULL,
  `rpttField4Label` varchar(45) DEFAULT NULL,
  `rptField4Val` varchar(255) DEFAULT NULL,
  `dateCreated` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `uploadType` varchar(1) DEFAULT 'u' COMMENT 'U for Upload and D for download',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE `transactionOutErrors` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `BatchDownloads` int(11) NOT NULL,
  `transactionTargetId` int(11) NOT NULL,
  `fieldLabel` varchar(45) DEFAULT NULL,
  `errorColumn` varchar(5) DEFAULT NULL COMMENT 'F1, F2, F3, etc.',
  `errorValue` varchar(255) NOT NULL,
  `rpttField1Label` varchar(45) DEFAULT NULL,
  `rptField1Val` varchar(255) DEFAULT NULL,
  `rptField2Label` varchar(45) DEFAULT NULL,
  `rptField2Val` varchar(255) DEFAULT NULL,
  `rptField3Val` varchar(45) DEFAULT NULL,
  `rptField3Label` varchar(255) DEFAULT NULL,
  `rpttField4Label` varchar(45) DEFAULT NULL,
  `rptField4Val` varchar(255) DEFAULT NULL,
  `dateCreated` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `downloadType` varchar(1) DEFAULT 'u' COMMENT 'U for Upload and D for download',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

ALTER TABLE `universalTranslator`.`transactionInErrors` 
CHANGE COLUMN `transactionId` `transactionInId` INT(11) NOT NULL ,
ADD INDEX `batchUploadIdFK_idx` (`batchUploadId` ASC);
ALTER TABLE `universalTranslator`.`transactionInErrors` 
ADD CONSTRAINT `batchUploadIdFK`
  FOREIGN KEY (`batchUploadId`)
  REFERENCES `universalTranslator`.`batchUploads` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

  ALTER TABLE `universalTranslator`.`transactionOutErrors` 
CHANGE COLUMN `BatchDownloads` `BatchDownloadId` INT(11) NOT NULL ,
ADD INDEX `batchDLFK_idx` (`BatchDownloadId` ASC);
ALTER TABLE `universalTranslator`.`transactionOutErrors` 
ADD CONSTRAINT `batchDLFK`
  FOREIGN KEY (`BatchDownloadId`)
  REFERENCES `universalTranslator`.`BatchDownloads` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  
  
 /** Grace 01.13.2014 **/
 ALTER TABLE `universalTranslator`.`transactionTranslatedIn` 
ADD COLUMN `configId` INT NOT NULL AFTER `transactionInId`;
 
ALTER TABLE `universalTranslator`.`transactionIn` 
CHANGE COLUMN `configId` `configId` INT(11) NULL ;

ALTER TABLE `universalTranslator`.`transactionIn` 
DROP FOREIGN KEY `configIdFK`;

/** READ ME

this will fail if you have data in transactionTranslatedIn as configId is now 0,
please update your configId or delete the rows first
 
**/

/**1.22.2014 Grace added this so added fk won't fail**/
UPDATE `universalTranslator`.`transactionTranslatedIn` SET `configId`='15' WHERE `id`='12';


ALTER TABLE `universalTranslator`.`transactionTranslatedIn` 
ADD INDEX `ttiConfigId_idx` (`configId` ASC);
ALTER TABLE `universalTranslator`.`transactionTranslatedIn` 
ADD CONSTRAINT `ttiConfigId`
  FOREIGN KEY (`configId`)
  REFERENCES `universalTranslator`.`configurations` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  
  
  
/** 01.13.2014 PM**/
ALTER TABLE `universalTranslator`.`transactionInErrors` 
DROP COLUMN `uploadType`,
DROP COLUMN `rptField4Val`,
DROP COLUMN `rpttField4Label`,
DROP COLUMN `rptField3Label`,
DROP COLUMN `rptField3Val`,
DROP COLUMN `rptField2Val`,
DROP COLUMN `rptField2Label`,
DROP COLUMN `rptField1Val`,
DROP COLUMN `rpttField1Label`,
DROP COLUMN `errorValue`,
DROP COLUMN `errorColumn`,
CHANGE COLUMN `fieldLabel` `configurationFormFieldsId` INT NOT NULL ;
  

ALTER TABLE `universalTranslator`.`transactionInErrors` 
ADD INDEX `configFFFKId_idx` (`configurationFormFieldsId` ASC);
ALTER TABLE `universalTranslator`.`transactionInErrors` 
ADD CONSTRAINT `configFFFKId`
  FOREIGN KEY (`configurationFormFieldsId`)
  REFERENCES `universalTranslator`.`configurationFormFields` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  
  
  ALTER TABLE `universalTranslator`.`transactionOutErrors` 
DROP COLUMN `downloadType`,
DROP COLUMN `rptField4Val`,
DROP COLUMN `rpttField4Label`,
DROP COLUMN `rptField3Label`,
DROP COLUMN `rptField3Val`,
DROP COLUMN `rptField2Val`,
DROP COLUMN `rptField2Label`,
DROP COLUMN `rptField1Val`,
DROP COLUMN `rpttField1Label`,
DROP COLUMN `errorValue`,
DROP COLUMN `errorColumn`,
CHANGE COLUMN `fieldLabel` `configurationFormFieldsId` INT NULL DEFAULT NULL ;
  
  
  ALTER TABLE `universalTranslator`.`transactionOutErrors` 
ADD INDEX `configFFIdFK_idx` (`configurationFormFieldsId` ASC);
ALTER TABLE `universalTranslator`.`transactionOutErrors` 
ADD CONSTRAINT `configFFIdFK`
  FOREIGN KEY (`configurationFormFieldsId`)
  REFERENCES `universalTranslator`.`configurationFormFields` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  
/** grace 01.14.14**/
drop table `universalTranslator`.`transactionErrors`;

/* Chad 01.14.2014 @ 10:25 AM */
ALTER TABLE `universalTranslator`.`configurations` 
ADD COLUMN `configName` VARCHAR(45) NOT NULL AFTER `stepsCompleted`;

/* Chad 01.15.2014 @ 11:43 AM */
ALTER TABLE `universaltranslator`.`users` 
ADD COLUMN `editAuthority` BIT(1) NOT NULL DEFAULT b'0' AFTER `deliverAuthority`;

/* Chad 01.15.14 @ 3:05 PM */
CREATE TABLE `universalTranslator`.`batchUploadSummary` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `batchId` INT NOT NULL,
  `transactionInId` INT NOT NULL,
  `sourceOrgId` INT NOT NULL,
  `targetOrgId` INT NOT NULL,
  `messageTypeId` INT NOT NULL,
  `sourceConfigId` INT NOT NULL,
  PRIMARY KEY (`id`),
  INDEX `sumBatchIdfk_idx` (`batchId` ASC),
  INDEX `sumTransactionIdfk_idx` (`transactionInId` ASC),
  INDEX `sumSourceOrgIdfk_idx` (`sourceOrgId` ASC),
  INDEX `sumTargetOrgIdfk_idx` (`targetOrgId` ASC),
  INDEX `sumMessageTypeIdfk_idx` (`messageTypeId` ASC),
  INDEX `sumConfigIdfk_idx` (`sourceConfigId` ASC),
  CONSTRAINT `sumBatchIdfk`
    FOREIGN KEY (`batchId`)
    REFERENCES `universalTranslator`.`batchUploads` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `sumTransactionIdfk`
    FOREIGN KEY (`transactionInId`)
    REFERENCES `universalTranslator`.`transactionIn` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `sumSourceOrgIdfk`
    FOREIGN KEY (`sourceOrgId`)
    REFERENCES `universalTranslator`.`organizations` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `sumTargetOrgIdfk`
    FOREIGN KEY (`targetOrgId`)
    REFERENCES `universalTranslator`.`organizations` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `sumMessageTypeIdfk`
    FOREIGN KEY (`messageTypeId`)
    REFERENCES `universalTranslator`.`messagetypes` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `sumConfigIdfk`
    FOREIGN KEY (`sourceConfigId`)
    REFERENCES `universalTranslator`.`configurations` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

/*Grace 01.16.14 */
 ALTER TABLE `universalTranslator`.`transactionTranslatedOut` 
ADD COLUMN `configId` INT NOT NULL AFTER `transactionTargetId`;

ALTER TABLE `universalTranslator`.`transactionTranslatedOut` 
ADD INDEX `ttoConfigFK_idx` (`configId` ASC);
ALTER TABLE `universalTranslator`.`transactionTranslatedOut` 
ADD CONSTRAINT `ttoConfigFK`
  FOREIGN KEY (`configId`)
  REFERENCES `universalTranslator`.`configurations` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

/* Chad 1.16.14 @ 11:09 AM */
ALTER TABLE `universalTranslator`.`users` 
ADD COLUMN `createAuthority` BIT(1) NOT NULL DEFAULT b'0' AFTER `editAuthority`,
ADD COLUMN `cancelAuthority` BIT(1) NOT NULL DEFAULT b'0' AFTER `createAuthority`;

/** 1.19.2014 Grace **/

CREATE FUNCTION strSplit(x varchar(255), delim varchar(12), pos int) returns varchar(255)
return replace(substring(substring_index(x, delim, pos), 
length(substring_index(x, delim, pos - 1)) + 1), delim, '');

/** 1.20.2014 grace **/

delimiter $$
create procedure setSqlForConfig(in inConfigId int, in batchUploadId int)
proc_main:begin
drop TEMPORARY TABLE if exists temp1;
CREATE TEMPORARY TABLE temp1
as (select min(fieldNo) as fieldNo, saveToTableName, savetotablecol, configId, batchUploadId
from configurationFormFields where configId = inConfigId
group by savetotablecol, saveToTableName);
SELECT  batchuploadId, saveToTableName, 
group_concat(distinct savetotablecol ORDER BY savetotablecol SEPARATOR ',') as savetotablecol,
group_concat( concat('F',fieldNo) ORDER BY fieldNo SEPARATOR ',') as singleValueFields, 
group_concat( concat('strSplit(F',fieldNo, ', ''||^||'',@valPos)') ORDER BY fieldNo SEPARATOR ',') as splitFields, 
group_concat( concat('F',fieldNo, ' like ''''%||^||%''''') ORDER BY fieldNo SEPARATOR ' or ') as checkForDelim,
configId
FROM temp1 
where configId = inConfigId
GROUP BY saveToTableName
ORDER BY saveToTableName;
end proc_main$$

delimiter ;

/* 1.21.2014 Chad @ 10:30 AM */
ALTER TABLE `universalTranslator`.`configurations` 
ADD COLUMN `sourceType` SMALLINT NOT NULL DEFAULT '1' COMMENT '1 = Originating Message\n2 = Feedback Report' AFTER `configName`;


/*1.22.2014 Grace*/

drop procedure `universalTranslator`.`setSqlForConfig`;

/**recreate **/
delimiter $$
create procedure `universalTranslator`.`setSqlForConfig`(in inConfigId int, in batchUploadId int)
proc_main:begin
drop TEMPORARY TABLE if exists temp1;
CREATE TEMPORARY TABLE temp1
as (select min(fieldNo) as fieldNo, saveToTableName, savetotablecol, configId, batchUploadId
from configurationFormFields where configId = inConfigId
group by savetotablecol, saveToTableName);
SELECT  batchUploadId, saveToTableName, 
group_concat(distinct savetotablecol ORDER BY fieldNo SEPARATOR ',') as savetotablecol,
group_concat( concat('F',fieldNo) ORDER BY fieldNo SEPARATOR ',') as singleValueFields, 
group_concat( concat('strSplit(F',fieldNo, ', ''||^||'',@valPos)') ORDER BY fieldNo SEPARATOR ',') as splitFields, 
group_concat( concat('F',fieldNo, ' like ''%||^||%''') ORDER BY fieldNo SEPARATOR ' or ') as checkForDelim,
configId
FROM temp1 
where configId = inConfigId
GROUP BY saveToTableName
ORDER BY saveToTableName;
end proc_main$$

delimiter ;


/*1.22.2014 2:01 AM 
Do we need configId in the tables below?
*/
ALTER TABLE `universalTranslator`.`message_FromOrg` 
CHANGE COLUMN `configId` `configId` INT(11) NULL ;

ALTER TABLE `universalTranslator`.`message_FromProvider` 
CHANGE COLUMN `configId` `configId` INT(11) NULL ;

ALTER TABLE `universalTranslator`.`message_ToOrg` 
CHANGE COLUMN `configId` `configId` INT(11) NULL ;

ALTER TABLE `universalTranslator`.`message_ToProvider` 
CHANGE COLUMN `configId` `configId` INT(11) NULL ;

ALTER TABLE `universalTranslator`.`message_ToProvider` 
DROP FOREIGN KEY `FKMessToPProviderId`;
ALTER TABLE `universalTranslator`.`message_ToProvider` 
CHANGE COLUMN `providerId` `providerId` INT(11) NULL ;
ALTER TABLE `universalTranslator`.`message_ToProvider` 
ADD CONSTRAINT `FKMessToPProviderId`
  FOREIGN KEY (`providerId`)
  REFERENCES `universalTranslator`.`info_providers` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

ALTER TABLE `universalTranslator`.`message_FromOrg` 
DROP FOREIGN KEY `FKMessFromOrgId`;
ALTER TABLE `universalTranslator`.`message_FromOrg` 
CHANGE COLUMN `orgId` `orgId` INT(11) NULL ;
ALTER TABLE `universalTranslator`.`message_FromOrg` 
ADD CONSTRAINT `FKMessFromOrgId`
  FOREIGN KEY (`orgId`)
  REFERENCES `universalTranslator`.`organizations` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

ALTER TABLE `universalTranslator`.`message_FromProvider` 
DROP FOREIGN KEY `FKMessFromPProviderId`;
ALTER TABLE `universalTranslator`.`message_FromProvider` 
CHANGE COLUMN `providerId` `providerId` INT(11) NULL ;
ALTER TABLE `universalTranslator`.`message_FromProvider` 
ADD CONSTRAINT `FKMessFromPProviderId`
  FOREIGN KEY (`providerId`)
  REFERENCES `universalTranslator`.`info_providers` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;


ALTER TABLE `universalTranslator`.`message_ToOrg` 
DROP FOREIGN KEY `FKMessToOrgId`;
ALTER TABLE `universalTranslator`.`message_ToOrg` 
CHANGE COLUMN `orgId` `orgId` INT(11) NULL ;
ALTER TABLE `universalTranslator`.`message_ToOrg` 
ADD CONSTRAINT `FKMessToOrgId`
  FOREIGN KEY (`orgId`)
  REFERENCES `universalTranslator`.`organizations` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  

/** 01.22.2014 12:05 **/

ALTER TABLE `universalTranslator`.`message_ToOrg` 
DROP FOREIGN KEY `FKMessToOrgId`;
ALTER TABLE `universalTranslator`.`message_ToOrg` 
CHANGE COLUMN `orgId` `locationId` INT(11) NULL DEFAULT NULL ,
DROP INDEX `FKMessToOrgId_idx` ;

ALTER TABLE `universalTranslator`.`message_ToProvider` 
DROP FOREIGN KEY `FKMessToPProviderId`;

ALTER TABLE `universalTranslator`.`message_ToProvider` 
DROP INDEX `FKMessToPProviderId_idx` ;

ALTER TABLE `universalTranslator`.`message_FromOrg` 
DROP FOREIGN KEY `FKMessFromOrgId`;
ALTER TABLE `universalTranslator`.`message_FromOrg` 
DROP INDEX `FKMessFromOrgId_idx` ;

ALTER TABLE `universalTranslator`.`message_FromOrg` 
CHANGE COLUMN `orgId` `locationId` INT(11) NULL DEFAULT NULL ;

ALTER TABLE `universalTranslator`.`message_FromProvider` 
DROP FOREIGN KEY `FKMessFromPProviderId`;
ALTER TABLE `universalTranslator`.`message_FromProvider` 
DROP INDEX `FKMessFromPProviderId_idx` ;


/** grace 1.22.2014 1:37PM */
ALTER TABLE `universalTranslator`.`message_Patients` 
CHANGE COLUMN `englishProficient` `englishProficient` VARCHAR(10) NULL DEFAULT NULL COMMENT 'can be Yes, No, Unknown...\nWe wi\nso changing it to varchar' ;

/* 1.22.2014 5:04PM  Grace**/
ALTER TABLE `universalTranslator`.`message_VisitInfo` 
CHANGE COLUMN `incomeReported` `incomeReported` VARCHAR(10) NULL DEFAULT NULL COMMENT 'could be y, n, unknown, etc.' ,
ADD COLUMN `weight` FLOAT NULL AFTER `comments`,
ADD COLUMN `height` FLOAT NULL AFTER `weight`;

/* 1.23.14 Grace */
ALTER TABLE `universalTranslator`.`message_ToOrg` 
DROP COLUMN `configId`;

ALTER TABLE `universalTranslator`.`message_ToProvider` 
DROP COLUMN `configId`;

ALTER TABLE `universalTranslator`.`message_FromOrg` 
DROP COLUMN `configId`;

ALTER TABLE `universalTranslator`.`message_FromProvider` 
DROP COLUMN `configId`;

/**1.24.2014 Grace**/
INSERT INTO `universalTranslator`.`lu_ProcessStatus` (`category`, `displayCode`, `displayText`) VALUES ('batch', 'TBP', 'Target Batch Creation in Process');
INSERT INTO `universalTranslator`.`lu_ProcessStatus` (`category`, `displayCode`, `displayText`) VALUES ('batch', 'TBC', 'Target Batch Created');

/*1.24.14 Grace PM */
ALTER TABLE `universaltranslator`.`message_Visitinfo` 
DROP FOREIGN KEY `mdTransFK`;
ALTER TABLE `universaltranslator`.`message_VisitInfo` 
ADD CONSTRAINT `mdTransFK`
  FOREIGN KEY (`transactionInId`)
  REFERENCES `universaltranslator`.`transactionin` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  
  
  /*1.24.14 Grace 2:04 PM*/
INSERT INTO `universalTranslator`.`lu_ProcessStatus` (`category`, `displayCode`, `displayText`) VALUES ('batch', 'SPE', 'Submission Process Errored');
INSERT INTO `universalTranslator`.`lu_ProcessStatus` (`category`, `displayCode`, `displayText`) VALUES ('batch', 'TPE', 'Target Creation Errored');

/*1.25.2014 */
ALTER TABLE `universalTranslator`.`transactionInErrors` 
ADD COLUMN `errorId` INT NULL AFTER `configurationFormFieldsId`;

INSERT INTO `universalTranslator`.`lookUpTables` (`utTableName`, `displayText`) VALUES ('lu_ErrorCodes', 'Validation Error Codes');

CREATE TABLE `universalTranslator`.`lu_ErrorCodes` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `displayText` VARCHAR(45) NOT NULL,
  `description` VARCHAR(200) NULL,
  `isCustom` BIT NOT NULL DEFAULT 0,
  `status` BIT NOT NULL DEFAULT 1,
  `dateCreated` DATETIME NOT NULL DEFAULT current_timestamp,
  `dateModified` DATETIME NOT NULL DEFAULT current_timestamp,
  PRIMARY KEY (`id`));

INSERT INTO `universalTranslator`.`lu_ErrorCodes` (`displayText`, `description`) VALUES ('Required Field Check Failed', 'Value not provided for required field');
INSERT INTO `universalTranslator`.`lu_ErrorCodes` (`displayText`, `description`) VALUES ('Failed Validation', 'Failed Validation');
INSERT INTO `universalTranslator`.`lu_ErrorCodes` (`displayText`, `description`) VALUES ('Failed Crosswalks or Macros', 'Failed Crosswalks/ Macro');

ALTER TABLE `universalTranslator`.`transactionInErrors` 
ADD INDEX `errorIdFK_idx` (`errorId` ASC);
ALTER TABLE `universalTranslator`.`transactionInErrors` 
ADD CONSTRAINT `errorIdFK`
  FOREIGN KEY (`errorId`)
  REFERENCES `universalTranslator`.`lu_ErrorCodes` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

ALTER TABLE `universalTranslator`.`transactionOutErrors` 
ADD COLUMN `errorId` INT NULL AFTER `configurationFormFieldsId`;

ALTER TABLE `universalTranslator`.`transactionOutErrors` 
ADD INDEX `FKErrorId_idx` (`errorId` ASC);
ALTER TABLE `universalTranslator`.`transactionOutErrors` 
ADD CONSTRAINT `FKErrorId`
  FOREIGN KEY (`errorId`)
  REFERENCES `universalTranslator`.`lu_ErrorCodes` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;
  
  /**1.26.14 Grace **/
  UPDATE `universalTranslator`.`lookUpTables` SET `urlId`='8221Err4102des' WHERE `id`='33';

/** Chad 1.27.14 @ 12:36 PM **/
CREATE TABLE `universalTranslator`.`batchDownloadSummary` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `batchId` INT NOT NULL,
  `transactionTargetId` INT NOT NULL,
  `sourceOrgId` INT NOT NULL,
  `targetOrgId` INT NOT NULL,
  `messageTypeId` INT NOT NULL,
  `targetConfigId` INT NOT NULL,
  PRIMARY KEY (`id`),
  INDEX `dwnSumBatchIdFk_idx` (`batchId` ASC),
  INDEX `dwnSumConfigIdFk_idx` (`targetConfigId` ASC),
  INDEX `dwnSumMessageTypeIdFk_idx` (`messageTypeId` ASC),
  INDEX `dwnSumOrgIdFk_idx` (`sourceOrgId` ASC),
  INDEX `dwnSumTargetOrgIdFk_idx` (`targetOrgId` ASC),
  INDEX `dwnSumTransactionIdFk_idx` (`transactionTargetId` ASC),
  CONSTRAINT `dwnSumBatchIdFk`
    FOREIGN KEY (`batchId`)
    REFERENCES `universalTranslator`.`BatchDownloads` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `dwnSumConfigIdFk`
    FOREIGN KEY (`targetConfigId`)
    REFERENCES `universalTranslator`.`configurations` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `dwnSumMessageTypeIdFk`
    FOREIGN KEY (`messageTypeId`)
    REFERENCES `universalTranslator`.`messagetypes` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `dwnSumSourceOrgIdFk`
    FOREIGN KEY (`sourceOrgId`)
    REFERENCES `universalTranslator`.`organizations` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `dwnSumTargetOrgIdFk`
    FOREIGN KEY (`targetOrgId`)
    REFERENCES `universalTranslator`.`organizations` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `dwnSumTransactionIdFk`
    FOREIGN KEY (`transactionTargetId`)
    REFERENCES `universalTranslator`.`transactionTarget` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

  
/** Chad 1.27.14 @ 3:22 PM **/
ALTER TABLE `universalTranslator`.`BatchDownloads` 
ADD COLUMN `utBatchName` VARCHAR(255) NOT NULL AFTER `userId`;

/** Grace 1.28.14 */
UPDATE `universalTranslator`.`lu_ErrorCodes` SET `displayText`='Failed Validation - Email' WHERE `id`='2';
INSERT INTO `universalTranslator`.`lu_ErrorCodes` (`displayText`) VALUES ('Failed Validation - Phone');
INSERT INTO `universalTranslator`.`lu_ErrorCodes` (`displayText`) VALUES ('Failed Validation - Numeric');
INSERT INTO `universalTranslator`.`lu_ErrorCodes` (`displayText`) VALUES ('Failed Validation - URL');
INSERT INTO `universalTranslator`.`lu_ErrorCodes` (`displayText`) VALUES ('Failed Validation - Date');

  
/** grace 1.29.2014 **/
DELETE FROM `universalTranslator`.`lu_ErrorCodes` WHERE `id`='4';
DELETE FROM `universalTranslator`.`lu_ErrorCodes` WHERE `id`='5';
DELETE FROM `universalTranslator`.`lu_ErrorCodes` WHERE `id`='6';
DELETE FROM `universalTranslator`.`lu_ErrorCodes` WHERE `id`='7';

ALTER TABLE `universalTranslator`.`transactionInErrors` 
ADD COLUMN `cwId` INT NULL AFTER `errorId`,
ADD COLUMN `macroId` INT NULL AFTER `cwId`,
ADD COLUMN `validationTypeId` INT NULL AFTER `macroId`;

ALTER TABLE `universalTranslator`.`transactionInErrors` 
CHANGE COLUMN `dateCreated` `dateCreated` DATETIME NULL DEFAULT CURRENT_TIMESTAMP ;

ALTER TABLE `universalTranslator`.`transactionInErrors` 
ADD INDEX `tieVTFK_idx` (`validationTypeId` ASC),
ADD INDEX `tieCWFK_idx` (`cwId` ASC),
ADD INDEX `tieMacroFK_idx` (`macroId` ASC);
ALTER TABLE `universalTranslator`.`transactionInErrors` 
ADD CONSTRAINT `tieVTFK`
  FOREIGN KEY (`validationTypeId`)
  REFERENCES `universalTranslator`.`ref_validationTypes` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION,
ADD CONSTRAINT `tieCWFK`
  FOREIGN KEY (`cwId`)
  REFERENCES `universalTranslator`.`crosswalks` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION,
ADD CONSTRAINT `tieMacroFK`
  FOREIGN KEY (`macroId`)
  REFERENCES `universalTranslator`.`Macro_Names` (`ID`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

UPDATE `universalTranslator`.`lu_errorcodes` SET `displayText`='Failed Validation' WHERE `id`='2';

DELIMITER $$
CREATE PROCEDURE `insertValidationErrors`(in vtType int, in fieldNo int,
in batchUploadId int, in configId int, in cffId int)
BEGIN

DECLARE regEx varchar(100) DEFAULT '';

CASE vtType
	WHEN 2 THEN set regEx = '^[a-z0-9\._%+!$&*=^|~#%\'`?{}/\-]+@[a-z0-9\.-]+\.[a-z]{2,6}$ or ^[A-Z0-9._%-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$';
    WHEN 5 THEN set regEx = '^-?[0-9]+[.]?[0-9]*$|^-?[.][0-9]+$';
    END CASE;
 
set @stmt = concat(
'insert into transactionInerrors (batchUploadId, transactionInId, configurationFormFieldsId, errorid, 
validationTypeId) SELECT ', batchUploadId, ', transactionInId, ',cffId,',2, ', vtType,'  
 FROM transactionTranslatedIn WHERE F' ,fieldNo, ' not REGEXP  ''', regEx, ''' and F',fieldNo, ' is not null and configId = ', configId, ' and transactionInId 
in (select id from transactionIn where batchId = ', batchUploadId,' and configId = ', configId,');');

PREPARE stmt from @stmt;
EXECUTE stmt;

 END$$
DELIMITER ;

/**Grace 01.29.2014 **/
drop PROCEDURE `universalTranslator`.`insertValidationErrors`;

DELIMITER $$
CREATE PROCEDURE `universalTranslator`.`insertValidationErrors`(in vtType int, in fieldNo int,
in batchUploadId int, in configId int, in cffId int)
BEGIN

DECLARE regEx varchar(100) DEFAULT '';

CASE vtType
	WHEN 2 THEN set regEx = '^[a-z0-9\._%+!$&*=^|~#%\'`?{}/\-]+@[a-z0-9\.-]+\.[a-z]{2,6}$ or ^[A-Z0-9._%-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$';
    WHEN 5 THEN set regEx = '^-?[0-9]+[.]?[0-9]*$|^-?[.][0-9]+$';
    ELSE
        BEGIN
        END;
	END 
	CASE;
 
set @stmt = concat(
'insert into transactionInerrors (batchUploadId, transactionInId, configurationFormFieldsId, errorid, 
validationTypeId) SELECT ', batchUploadId, ', transactionInId, ',cffId,',2, ', vtType,'  
 FROM transactionTranslatedIn WHERE F' ,fieldNo, ' not REGEXP  "', regEx, '" and F',fieldNo, ' is not null and configId = ', configId, ' and transactionInId 
in (select id from transactionIn where batchId = ', batchUploadId,' and configId = ', configId,');');

PREPARE stmt from @stmt;
EXECUTE stmt;

 END$$
DELIMITER ;


/** Chad 1.29.2014 @ 2:41 PM **/
CREATE TABLE `universalTranslator`.`lu_internalMessageStatus` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `displayText` VARCHAR(45) NOT NULL,
  `status` BIT(1) NOT NULL DEFAULT b'1',
  PRIMARY KEY (`id`));

INSERT INTO `universalTranslator`.`lu_internalMessageStatus` (`displayText`, `status`) VALUES ('Appointment Scheduled', 1);
INSERT INTO `universalTranslator`.`lu_internalMessageStatus` (`displayText`, `status`) VALUES ('Complete Program', 1);
INSERT INTO `universalTranslator`.`lu_internalMessageStatus` (`displayText`, `status`) VALUES ('In Progress', 1);
INSERT INTO `universalTranslator`.`lu_internalMessageStatus` (`displayText`, `status`) VALUES ('Patient Contacted', 1);
INSERT INTO `universalTranslator`.`lu_internalMessageStatus` (`displayText`, `status`) VALUES ('Patient Enrolled', 1);
INSERT INTO `universalTranslator`.`lu_internalMessageStatus` (`displayText`, `status`) VALUES ('Patient No Show', 1);
INSERT INTO `universalTranslator`.`lu_internalMessageStatus` (`displayText`, `status`) VALUES ('Patient Refused Service', 1);
INSERT INTO `universalTranslator`.`lu_internalMessageStatus` (`displayText`) VALUES ('Unable to Contact Patient');

  
  

