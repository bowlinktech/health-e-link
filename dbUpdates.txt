/** grace 06052014 10:02 **/

update configurationDataTranslations set categoryId = 1;

ALTER TABLE `universaltranslator`.`configurationdatatranslations` 
CHANGE COLUMN `categoryId` `categoryId` INT(11) NULL DEFAULT 1 COMMENT '2 pre - processing\n3 - post processing\n1 -  while- processing\n' ;


/** grace 06052014 11:03PM **/
INSERT INTO `universaltranslator`.`macro_names` (`ID`, `CategoryId`, `Macro_Name`, `Macro_Short_Name`, `Formula`, `FieldA_Question`, `Con1_Question`, `Con2_Question`) VALUES ('77', '2', 'Remove Transaction and Targets', 'removeTransactionTargets', 'removeTransactionTargets', 'Please enter field to check', 'Please enter transport method', 'Please enter org ids if there are multiple organizations (optional).  Leave blank to delete all target associated with batch.');
UPDATE `universaltranslator`.`macro_names` SET `populateFieldA`=0 WHERE `ID`='77';

ALTER TABLE `universaltranslator`.`macro_names` 
CHANGE COLUMN `populateFieldA` `populateFieldA` BIT(1) NULL DEFAULT 1 ;



use universaltranslator;

drop procedure if exists removeTransactionTargets;

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `removeTransactionTargets`(in configId int, 
in batchId int, in srcField varchar(10),
in fieldA varchar(10), in fieldB varchar(10), in con1 varchar(255), 
in con2 varchar(255), in macroId int, in foroutboundProcessing boolean, in passClear int, in transactionId int)

proc_main:begin

/**
fieldA - field to look for value
fieldB - not in use
con1 - value to match
con2 - target organizations to apply rule to
**/

-- 1. quering target transactionInIds from batchSummary
start transaction;

set @stmt1 = 
concat("select group_concat(transactionInId order by transactionInId, ',') into @listOfIds
 from batchUploadSummary where sourceConfigId = ", configId,  " and targetConfigId in 
(select configId from configurationTransportDetails where transportMethodid 
in (select id from ref_transportmethods where transportMethod = '", con1,"') 
and configId in (select id from configurations where status = 1 ");

set @stmt2 = '';

if (con2 != '') then
BEGIN
set @stmt2 = concat(" and orgId in (", con2, ")");
END;
end if;

set @stmt = concat(@stmt1, @stmt2, ") and batchId = ", batchId,");");

PREPARE stmt from @stmt;
EXECUTE stmt;-- execute


if (@listOfIds is not null) then
BEGIN
-- we have data, we delete from these tables
-- start our transaction here

set @del1 = concat("delete from transactionInErrors where transactionInId in (", @listOfIds, ");");
set @del2 = concat("delete from transactionInRecords where transactionInId in (", @listOfIds, ");");
set @del3 = concat("delete from transactionTranslatedIn where transactionInId in (", @listOfIds, ");");
set @del4 = concat("delete from transactionTarget where transactionInId in (", @listOfIds, ");");
set @del5 = concat("delete from batchUploadSummary where transactionInId in (", @listOfIds, ");");
set @del6 = concat("delete from transactionIn where id in (", @listOfIds, ");");



PREPARE delStmt from @del1;
EXECUTE delStmt;-- execute

PREPARE delStmt from @del2;
EXECUTE delStmt;-- execute

PREPARE delStmt from @del3;
EXECUTE delStmt;-- execute

PREPARE delStmt from @del4;
EXECUTE delStmt;-- execute

PREPARE delStmt from @del5;
EXECUTE delStmt;-- execute

PREPARE delStmt from @del6;
EXECUTE delStmt;-- execute

END;
end if;

EXECUTE stmt;-- execute

set @returnText = 'failed';
if (@listOfIds is not null) then
rollback;
else
set @returnText ='success';
COMMIT;
end if;

select @returnText;

end proc_main$$
DELIMITER ;



/** grace 10:44AM 06062014 **/
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='The file has failed either size, delimiter, type or is blank.' WHERE `id`='1';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='The file is uploaded and has met size, type, delimiter requirement.  It will be loaded into the database and translated.' WHERE `id`='2';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='This is when a user fixes transactions on ERG and resubmits them for process.' WHERE `id`='3';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='This is the intrim status that locks the file.  It is flagged so the scheudler won\'t pick it up for process.' WHERE `id`='4';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='This is when a file is processed but pending review' WHERE `id`='5';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='This is when the batch has all final status.  It will be picked up by the scheudler and insert into UT db.' WHERE `id`='6';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='This is when the entire batch is rejected after processing.  This status happens when every record in the batch fails or when the user selects fail batch when there are errored records' WHERE `id`='7';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='This is when a user enter in an ERG and decides to return and complete it later.' WHERE `id`='8';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='?? I am not sure what the difference between this and cancel (SCN - Cancelled) is. But this flags the batch to not be process. ' WHERE `id`='21';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='This is when a batch is delivered and at least one record (but not all) is viewed by an end user' WHERE `id`='22';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='This is when an entire batch has been delivered and viewed by user.' WHERE `id`='23';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='This is when a batch are all in final status and inserted into the UT db.' WHERE `id`='24';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='STP', `displayText`='Submission Target Being Process', `description`='This is an interim status for when a submission target is being generated' WHERE `id`='25';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayText`='Submission Target Created', `description`='This is when a submission target is created but before it is delivered to users' WHERE `id`='28';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `description`='This is when an unexpected error happened during processing.  This usually will require code fixing or cw/macro update.  It means the cw, macro or something went wrong.' WHERE `id`='29';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayCode`='STPE', `displayText`='Submission Target Processing Errored' WHERE `id`='30';

INSERT INTO `universaltranslator`.`lu_ProcessStatus` (`id`, `category`, `displayCode`, `displayText`, `description`) VALUES ('37', 'transaction', 'TCP', 'Transaction Creation Processing', 'This is when a transaction is picked up by the scheduler and the translation is happening');

