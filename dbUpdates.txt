/* Chad 12.19.2013 */

ALTER TABLE `universalTranslator`.`configurations` 
DROP COLUMN `rejectOnError`,
DROP COLUMN `clearFields`,
ADD COLUMN `userId` INT NOT NULL AFTER `orgId`,
ADD INDEX `configUserIdfk_idx` (`userId` ASC);
ALTER TABLE `universalTranslator`.`configurations` 
ADD CONSTRAINT `configUserIdfk`
  FOREIGN KEY (`userId`)
  REFERENCES `universalTranslator`.`users` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

ALTER TABLE `universalTranslator`.`configurationTransportDetails` 
DROP COLUMN `reportableField4`,
DROP COLUMN `reportableField3`,
DROP COLUMN `reportableField2`,
DROP COLUMN `reportableField1`,
DROP COLUMN `containsHeader`,
DROP COLUMN `targetOrgColNo`,
DROP COLUMN `messageTypeCustomVal`,
DROP COLUMN `messageTypeColNo`,
ADD COLUMN `clearRecords` BIT NULL DEFAULT False AFTER `maxFileSize`,
ADD COLUMN `fileLocation` VARCHAR(255) NULL DEFAULT NULL AFTER `clearRecords`,
ADD COLUMN `autoRelease` BIT NULL DEFAULT True AFTER `fileLocation`,
ADD COLUMN `errorHandling` SMALLINT NOT NULL DEFAULT 1 COMMENT '1 = Post errors to ERG\n2 = Reject record on error\n3 = Reject submission on error\n4 = Pass through errors' AFTER `autoRelease`,
ADD COLUMN `mergeBatches` BIT NULL DEFAULT True AFTER `errorHandling`;

CREATE TABLE `universalTranslator`.`configurationTransportMessageTypes` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `configTransportId` INT NOT NULL,
  `configId` INT NOT NULL,
  PRIMARY KEY (`id`),
  INDEX `configTransIdfk_idx` (`configId` ASC),
  INDEX `configTransportIdfk_idx` (`configTransportId` ASC),
  CONSTRAINT `configTransconfigIdfk`
    FOREIGN KEY (`configId`)
    REFERENCES `universalTranslator`.`configurations` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `configTransportIdfk`
    FOREIGN KEY (`configTransportId`)
    REFERENCES `universalTranslator`.`configurationTransportDetails` (`id`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION);

ALTER TABLE `universalTranslator`.`rel_configurationDataTranslations` 
RENAME TO  `universalTranslator`.`configurationDataTranslations` ;

ALTER TABLE `universalTranslator`.`configurationTransportDetails` 
DROP FOREIGN KEY `fkTransport`;
ALTER TABLE `universalTranslator`.`configurationTransportDetails` 
CHANGE COLUMN `transportMethod` `transportMethodId` INT(11) NOT NULL ;
ALTER TABLE `universalTranslator`.`configurationTransportDetails` 
ADD CONSTRAINT `fkTransport`
  FOREIGN KEY (`transportMethodId`)
  REFERENCES `universalTranslator`.`ref_transportMethods` (`id`)
  ON DELETE NO ACTION
  ON UPDATE NO ACTION;

UPDATE `universalTranslator`.`ref_transportMethods` SET `transportMethod`='ERG' WHERE `id`='2';