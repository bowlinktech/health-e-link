/** grace 06202014 11:15AM **/
ALTER TABLE `universaltranslator`.`movefileslog` 
ADD INDEX `pathMethodInd` (`transportMethodId` ASC, `folderPath` ASC, `method` ASC);


/** grace 06242014 07:26AM **/
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayText`='Transaction Closed' WHERE `id`='17';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayText`='Transaction Pending Pickup' WHERE `id`='18';
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `displayText`='Transaction  Pending Output' WHERE `id`='19';
UPDATE `universaltranslator`.`lu_processstatus` SET `displayText`='Transaction Invalid', `endUserDisplayText`='Transaction Invalid' WHERE `id`='11';
UPDATE `universaltranslator`.`lu_processstatus` SET `endUserDisplayText`='Transaction Closed' WHERE `id`='17';
UPDATE `universaltranslator`.`lu_processstatus` SET `endUserDisplayText`='Transaction Pending Pickup' WHERE `id`='18';
UPDATE `universaltranslator`.`lu_processstatus` SET `endUserDisplayText`='Transaction  Pending Output' WHERE `id`='19';
UPDATE `universaltranslator`.`lu_processstatus` SET `description`='Normal condition: All transactions for the submission have been delivered to the destination(s). NOTE: Source submission received (SSR) is the status which indicates that the destination has actually RECEIVED the transaction(s).' WHERE `id`='28';
UPDATE `universaltranslator`.`lu_processstatus` SET `displayText`='Transaction Invalid', `endUserDisplayText`='Transaction Invalid' WHERE `id`='11';
UPDATE `universaltranslator`.`lu_processstatus` SET `description`='Normal condition: This is when user closes the transaction in the eRG.  When a transaction is closed, users can no longer create feedback reports.', `endUserDescription`='Normal condition: This is when user closes the transaction in the eRG.  When a transaction is closed, users can no longer create feedback reports.' WHERE `id`='17';

/** grace 06252014 10:20 PM **/
UPDATE `universaltranslator`.`lu_ProcessStatus` SET `endUserDisplayCode`='DNP', `endUserDisplayText`='Do Not Process' WHERE `id`='35';


/** grace 06272014 11:59 AM **/

use universaltranslator;

drop procedure if exists replaceBlanksWithChars ;

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `replaceBlanksWithChars`(in configId int, 
in batchId int, in srcField varchar(10),
in fieldA varchar(10), in fieldB varchar(10), in con1 varchar(255), 
in con2 varchar(255), in macroId int, in foroutboundProcessing boolean, in passClear int, in transactionId int)
proc_main:begin

-- this SP matches null or empty for fieldA and will replace it with con1
-- FieldA - Field you would like to replace
-- Con1 - what value would you like to replace null with

set @fieldToReplace = fieldA;
if (fieldB != 'F') then
	set @fieldToReplace = fieldB;
end if;

-- this sets out table
call setInboundOutBoundTables (foroutboundProcessing);
select @translatedTable, @transactionTable, @batchTable, @batchIdType , @errorTable
into @translatedTable, @transactionTable, @batchTable, @batchIdType , @errorTable;

call getFinalStatusIds;
select @finalStatusIds into @finalStatusIds;

-- build our sql
if (transactionId = 0) then
	set @stmt = concat("update ",@translatedTable, " set ",fieldA," = '" ,con1,  "' where (",@fieldToReplace, " is null  
	or length(REPLACE(REPLACE('", fieldA, "', ""\n"", """"), ""\r"", """")) = 0)and ",
	@transactionTable,"Id in (select id from ",@transactionTable,
				" where configId = ",configId," and ", @batchIdType," = ",batchId," and statusId not in (",@finalStatusIds ,"));");
	END if;



if (transactionId != 0) then
	set @stmt = concat("update ",@translatedTable, " set ",fieldA," = '",con1, "' where (", @fieldToReplace , " is null
		or length(REPLACE(REPLACE('", fieldA, "', ""\n"", """"), ""\r"", """")) = 0)and ",
	@transactionTable,"Id = ", transactionId,";");
	END if;


	PREPARE stmt from @stmt;
	EXECUTE stmt;-- execute



-- we check pass /clear
if (passClear = 2) THEN
BEGIN
-- accessible
END;
END IF;


-- the only error for this is if SP bombs, no need to write in insert error logs
select '';
end proc_main$$
DELIMITER ;


/** chad 6272014 @ 1:33 PM These are all done in all DBs EXCEPT PTEST **/
INSERT INTO `universaltranslator`.`lu_races` (`displayText`, `isCustom`, `status`) VALUES ('Chinese', 0, 1);
INSERT INTO `universaltranslator`.`lu_races` (`displayText`, `isCustom`, `status`) VALUES ('Taiwanese', 0, 1);
INSERT INTO `universaltranslator`.`lu_races` (`displayText`, `isCustom`, `status`) VALUES ('Filipino', 0, 1);
INSERT INTO `universaltranslator`.`lu_races` (`displayText`, `isCustom`, `status`) VALUES ('Hmong', 0, 1);
INSERT INTO `universaltranslator`.`lu_races` (`displayText`, `isCustom`, `status`) VALUES ('Indonesian', 0, 1);
INSERT INTO `universaltranslator`.`lu_races` (`displayText`, `isCustom`, `status`) VALUES ('Japanese', 0, 1);
INSERT INTO `universaltranslator`.`lu_races` (`displayText`, `isCustom`, `status`) VALUES ('Korean', 0, 1);
INSERT INTO `universaltranslator`.`lu_races` (`displayText`, `isCustom`, `status`) VALUES ('Laotian', 0, 1);
INSERT INTO `universaltranslator`.`lu_races` (`displayText`, `isCustom`, `status`) VALUES ('Ethiopian', 0, 1);
INSERT INTO `universaltranslator`.`lu_races` (`displayText`, `isCustom`, `status`) VALUES ('Liberian', 0, 1);
INSERT INTO `universaltranslator`.`lu_races` (`displayText`, `isCustom`, `status`) VALUES ('Nigerian', 0, 1);

INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Spaniard', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Andalusian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Asturian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Castillian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Catalonian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Belearic Islander', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Gallego', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Valencian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Canarian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Spanish Basque', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Mexican', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Mexican American', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `description`, `isCustom`, `status`) VALUES ('Mexicano', NULL, 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Chicano', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('La Raza', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Mexican American Indian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Central American', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Costa Rican', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Guatemalan', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Honduran', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Nicaraguan', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Panamanian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Salvadoran', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Central American Indian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Canal Zone', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('South American', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Argentinean', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Bolivian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Chilean', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Colombian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Ecuadorian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Paraguayan', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Peruvian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Uruguayan', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Venezuelan', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('South American Indian', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Criollo', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Latin American/Latin, Latino', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Puerto Rican', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Cuban', 0, 1);
INSERT INTO `universaltranslator`.`lu_hispanics` (`displayText`, `isCustom`, `status`) VALUES ('Dominican', 0, 1);

/** grace 06302014 09:05PM **/
INSERT INTO `universaltranslator`.`lu_errorcodes` (`id`,`displayText`, `description`, `isCustom`, `status`) VALUES (18, 'Can not process file', 'Transport method contains both hr/ccd and another file type', 0, 1);

/** grace 07012014 12:55PM **/
INSERT INTO `universaltranslator`.`Macro_Names` (`ID`, `CategoryId`, `Macro_Name`, `Macro_Short_Name`, `Formula`, `FieldA_Question`, `Con1_Question`, `populateFieldA`) VALUES ('82', '1', 'Covert yyyymmdd String to Date', 'yyyymmdd String to Date', 'yyyymmddToDate', 'Please enter field to convert', 'Please enter date separator (. , / , - )', 1);

drop procedure if exists yyyymmddToDate;

DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `yyyymmddToDate`(in configId int, 
in batchId int, in srcField varchar(10),
in fieldA varchar(10), in fieldB varchar(10), in con1 varchar(255), 
in con2 varchar(255), in macroId int, in foroutboundProcessing boolean, in passClear int, in transactionId int)
proc_main:begin

/** 
This procedure take a string in yyyymmdd format and convert it into yyyy-mm-dd. 
"-" can be "/" or "." or character of choice by user
fieldA will be field to convert
fieldB is not in use
con1 will be character of choice
con2 is not in use
**/

call setInboundOutBoundTables (foroutboundProcessing);
select @translatedTable, @transactionTable, @batchTable, @batchIdType , @errorTable
into @translatedTable, @transactionTable, @batchTable, @batchIdType , @errorTable;

call getFinalStatusIds;
select @finalStatusIds into @finalStatusIds;

-- we build sql here 
if (con1 = '') then
set con1 = '-';
end if;

set con2 = 5;
if (transactionId = 0) then
set @stmt = concat("update ", @translatedTable," set ",fieldA,
" = concat(substring(",fieldA,", 1,",con2,"-1), '",con1,"', substring(",fieldA,", ",con2,",(length(",fieldA,")))) where ", @transactionTable ,"Id in (select id from ",@transactionTable,
" where configId = ",configId," and ", @batchIdType," = ",batchId," and statusId not in (",@finalStatusIds,"));");
END if;

if (transactionId != 0) then
set @stmt = concat("update ", @translatedTable," set ",fieldA,
" = concat(substring(",fieldA,", 1,",con2,"-1), '",con1,"', substring(",fieldA,", ",con2, 
",(length(",fieldA,")))) where ", @transactionTable ,"Id = ",transactionId, ";");
END if;

PREPARE stmt from @stmt;
EXECUTE stmt;-- execute


set con2 = 8;
if (transactionId = 0) then
set @stmt1 = concat("update ", @translatedTable," set ",fieldA,
" = concat(substring(",fieldA,", 1,",con2,"-1), '",con1,"', substring(",fieldA,", ",con2,",(length(",fieldA,")))) where ", @transactionTable ,"Id in (select id from ",@transactionTable,
" where configId = ",configId," and ", @batchIdType," = ",batchId," and statusId not in (",@finalStatusIds,"));");
END if;

if (transactionId != 0) then
set @stmt1 = concat("update ", @translatedTable," set ",fieldA,
" = concat(substring(",fieldA,", 1,",con2,"-1), '",con1,"', substring(",fieldA,", ",con2, 
",(length(",fieldA,")))) where ", @transactionTable ,"Id = ",transactionId, ";");
END if;

PREPARE stmt1 from @stmt1;
EXECUTE stmt1;-- execute


-- we check pass /clear
if (passClear = 2) THEN
BEGIN
-- not sure how to pass clear this
END;
END IF;
-- see if we want to return something
select '';

end proc_main$$
DELIMITER ;


